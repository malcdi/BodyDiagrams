
<table>
  <tr>
	  <td>
		<p> Drag your mouse on the photo to define a region</p>
		<div class="photo-container">
		  <img id="body_view" src="/assets/<%=@cur_view.img_name %>" onmousedown="event.preventDefault();" alt="no photo"></img>
		  <canvas id="canvas" width="330" height="750" style="position:absolute; top:0px; background-color:transparent; border: 1px solid black;"></canvas>
		  <div id="tags"></div>
		  <div id="tagging"></div>
		</div>
		<ul id="menu-container">
				<li class="menu" id="1" style="color:#FFFFB2">Mild</li>
				<li class="menu" id="2" style="color:#FECC5C">Somewhat Mild</li>
				<li class="menu" id="3" style="color:#FD8D3C">Moderate</li>
				<li class="menu" id="4" style="color:#F03B20">Somewhat Severe</li>
				<li class="menu" id="5" style="color:#BD0026">Severe</li> Pain <br/>
				
				<li class="menu" id="6" style="color:#EDF8E9">Mild</li>
				<li class="menu" id="7" style="color:#BAE4B3">Somewhat Mild</li>
				<li class="menu" id="8" style="color:#74C476">Moderate</li>
				<li class="menu" id="9" style="color:#31A354">Somewhat Severe</li>
				<li class="menu" id="10" style="color:#006D2C">Severe</li> Numbness <br/>
				
				<li class="menu" id="11" style="color:#F1EEF6">Mild</li>
				<li class="menu" id="12" style="color:#BDC9E1">Somewhat Mild</li>
				<li class="menu" id="13" style="color:#74A9CF">Moderate</li>
				<li class="menu" id="14" style="color:#2B8CBE">Somewhat Severe</li>
				<li class="menu" id="15" style="color:#045A8D">Severe</li>
				<li><input type="text" name="annotate" id="annotate" value="enter symptom"/></li>
		</ul>
	  </td>
	  <td>
	  	<div id="view_change" onmouseup="change_view()"><img src="/assets/icon.png" alt="no photo"></img></div>
	  	<input id="view_id" type="hidden" value='<%=@cur_view.id%>'>
	  	<div id="coord"></div>â€‹
	  	<div id="free_or_region">
	  		<input type="radio" id="free" name="free_or_region" /><label for="free">Free Hand</label>
	  		<input type="radio" id="region" name="free_or_region" checked="checked" /><label for="region">By Region</label>
	  	</div>
		<div id="symptom_selection_panel">
			<input type="radio" id="pain" name="symptom_selection" checked="checked" /><label for="pain">pain</label><br/>
			<input type="radio" id="numbness" name="symptom_selection" /><label for="numbness">numbness</label><br/>
			<input type="radio" id="tingling" name="symptom_selection" /><label for="tingling">tingling</label><br/>
			<input type="radio" id="itchiness" name="symptom_selection" /><label for="itchiness">itchiness</label><br/>
			<input type="radio" id="no symptom" name="symptom_selection" /><label for="no symptom">no symptom</label><br/>
		</div>
	  </td>
  </tr>
</table>

<script type="text/javascript">

//DM: from colorbrewer; update soon
var colors = ['#e41a1c', '#377EB8', '#4DAF4A', '#984EA3', '#FF7F00'];
var pain_colors = ['#FFFFB2', '#FECC5C', '#FD8D3C', '#F03B20', '#BD0026'];
var numbness_colors = ['#EDF8E9', '#BAE4B3', '#74C476', '#31A354', '#006D2C'];
var other_colors = ['#F1EEF6', '#BDC9E1', '#74A9CF', '#2B8CBE', '#045A8D'];

/********** utils ******************/
// Thanks to http://stackoverflow.com/questions/55677/how-do-i-get-the-coordinates-of-a-mouse-click-on-a-canvas-element/4430498#4430498
function fixPosition(e, gCanvasElement){
	var x;
	var y;
	if (e.pageX || e.pageY) { 
		x = e.pageX;
		y = e.pageY;
	}
	else { 
		x = e.clientX + document.body.scrollLeft +
				document.documentElement.scrollLeft;
		y = e.clientY + document.body.scrollTop +
				document.documentElement.scrollTop;
	} 
	x -= gCanvasElement.offsetLeft;
	y -= gCanvasElement.offsetTop;
	return {x: x, y:y};
}

var views = {0:"/assets/front.png", 1:"/assets/right.png", 2:"/assets/back.png", 3:"/assets/left.png"};	
view_side_num='<%=@cur_view.view_side%>'
var photo_tagger;
var mousedown = false;
var ctx;
// When the DOM is ready, initialize the scripts.
jQuery(function( $ ){
	// Set up the photo tagger.
	$( "div.photo-container" ).photoTagger({
		
		// The API urls.
		loadURL: "/main/get_tags",
		saveURL: "/main/post_tag",
		deleteURL: "/main/remove_tags",
		
		// Default to turned on.
		// isTagCreationEnabled: false,
		
		// This will allow us to clean the response from 
		// a ColdFusion server (it will convert the 
		// uppercase keys to lowercase keys expected by
		// the photoTagger plugin.
		cleanAJAXResponse: cleanColdFusionJSONResponse
	});
	photo_tagger= $( "div.photo-container" ).data("photoTagger");
	
	/* Free Hand */
	var canvas = document.getElementById('canvas'),
		coord = document.getElementById('coord');
	ctx = canvas.getContext('2d');
	var offset={x:canvas.offsetParent.offsetLeft, y:canvas.offsetParent.offsetTop}; //get the offset 
	
	ctx.strokeStyle = colors[0];
	ctx.lineWidth = 5;
	 
	/* Other UI */
	$( "#menu-container" ).children().button();
	$("#free_or_region").change(
		function(){
			if($('input[name=free_or_region]:checked')[0].id=="free"){
				photo_tagger.ignoreMouseDown();		
				freeHandListenMouseDown();
			}
			else{
				photo_tagger.listenMouseDown();
				freeHandIgnoreMouseDown();
			}
		}
	);
	//color changing / pain hierarchy
	$("#symptom_selection_panel").change(
		function(){
			if($('input[name=symptom_selection]:checked')[0].id=="pain"){
				ctx.strokeStyle = colors[0];
			} else if($('input[name=symptom_selection]:checked')[0].id=="numbness"){
				ctx.strokeStyle = colors[1];
			} else if($('input[name=symptom_selection]:checked')[0].id=="tingling"){
				ctx.strokeStyle = colors[2];
			} else if($('input[name=symptom_selection]:checked')[0].id=="itchiness"){
				ctx.strokeStyle = colors[3];
			} else if($('input[name=symptom_selection]:checked')[0].id=="no symptom"){
				ctx.strokeStyle = colors[4];
			}	
		}
		)
});

/* save the information */
function change_view(){
	view_side_num=(view_side_num+1)%4;
	$.ajax({
		method: "get",
		url: "/main/get_view",
		data: {
			view_num: view_side_num
		},
		dataType: "json",
		cache: false,
		success: function( response ){
			//$( "div.photo-container" ).deleteAllTags();
			document.getElementById("body_view").src='/assets/'+response["img_name"];	
			document.getElementById("view_id").value=response["id"];
			//$( "div.photo-container" ).loadTags();
		}		
	});
}

function freeHandIgnoreMouseDown(){
	$("#canvas").unbind("mousedown");
	$("#canvas").unbind("mousemove");
	$("#canvas").unbind("mouseup");
}

function freeHandListenMouseDown(){
	$("#canvas").bind(
		"mousedown", 
		function(e){
			//var pos = fixPosition(e, canvas);
			var pos={x: e.offsetX, y:e.offsetY};
			mousedown = true;
			ctx.beginPath();
			ctx.moveTo(pos.x, pos.y);
	});
	
	$("#canvas").bind(
		"mousemove", 
		function(e){
			//var pos = fixPosition(e, canvas);
			var pos={x: e.offsetX, y:e.offsetY};
			coord.innerHTML = '(' + pos.x + ',' + pos.y + ')';
			if (mousedown) {
				console.log("x:"+pos.x + "  y:"+pos.y);
				ctx.lineTo(pos.x, pos.y);
				ctx.stroke();
			}
	});
	
	$("#canvas").bind(
		"mouseup", 
		function(e){
			mousedown = false;
	});

}
			  
</script>

